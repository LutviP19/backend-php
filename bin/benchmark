#!/usr/bin/env php
<?php
//The following code launches ab process and sending 100K request to OpenSwoole HTTP server with 128 connections.
$wait = new OpenSwoole\Atomic(0);
$pid = pcntl_fork();
if ($pid === 0) {
    $http = new OpenSwoole\Http\Server('127.0.0.1', 9501, 1);
    $http->set(['log_file' => '/dev/null', 'log_level' => OpenSwoole\Constant::LOG_INFO, 'worker_num' => OpenSwoole\Util::getCPUNum() * 2]);
    $http->on('workerStart', function () use ($wait) { $wait->set(1); });
    $http->on('request', function (OpenSwoole\Http\Request $request, OpenSwoole\Http\Response $response) {
        $response->end('<h1>Hello OpenSwoole!</h1>');
    });
    $http->start();
} else {
    $wait->wait();
    System('ab -c 1280 -n 1000000 -k http://127.0.0.1:9501/ 2>&1');
    OpenSwoole\Process::kill($pid);
}
OpenSwoole\Event::wait();
